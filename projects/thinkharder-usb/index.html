<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ThinkHarder-USB</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Archivo+Black&family=IBM+Plex+Mono:wght@400;600;700&family=Inter:wght@400;600;700;900&display=swap');

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Inter', sans-serif;
            background: #1a472a;
            background-image:
                radial-gradient(ellipse at 20% 50%, rgba(0,0,0,0.15) 0%, transparent 50%),
                radial-gradient(ellipse at 80% 50%, rgba(0,0,0,0.15) 0%, transparent 50%),
                url("data:image/svg+xml,%3Csvg width='60' height='60' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='60' height='60' filter='url(%23n)' opacity='0.04'/%3E%3C/svg%3E");
            color: #e8e0d0;
            min-height: 100vh;
        }

        /* === POOL TABLE RAIL === */
        .rail {
            background: linear-gradient(180deg, #5c3a1e 0%, #8b5e3c 6%, #a0724e 12%, #8b5e3c 18%, #6b4423 24%, #5c3a1e 30%, #4a2e15 100%);
            padding: 8px 0;
            position: sticky;
            top: 0;
            z-index: 100;
            border-bottom: 3px solid #2a1a08;
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
        }

        .rail-diamonds {
            display: flex;
            justify-content: center;
            gap: 60px;
            padding: 2px 0;
        }

        .diamond {
            width: 12px;
            height: 12px;
            background: #f5e6c8;
            border-radius: 50%;
            box-shadow: inset 0 1px 2px rgba(0,0,0,0.3), 0 1px 1px rgba(255,255,255,0.1);
        }

        /* === MAIN CONTAINER === */
        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 40px 30px 80px;
        }

        /* === HERO === */
        .hero {
            text-align: center;
            padding: 60px 20px 40px;
            position: relative;
        }

        .ball-number {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: radial-gradient(circle at 35% 35%, #ff6b6b, #cc2936 40%, #8b0000 80%, #4a0000);
            box-shadow:
                inset -8px -8px 20px rgba(0,0,0,0.4),
                inset 4px 4px 15px rgba(255,255,255,0.15),
                0 8px 30px rgba(0,0,0,0.5),
                0 0 60px rgba(204,41,54,0.2);
            margin-bottom: 30px;
            position: relative;
        }

        .ball-number::after {
            content: '';
            position: absolute;
            width: 50px;
            height: 50px;
            background: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .ball-number span {
            position: relative;
            z-index: 1;
            font-family: 'Archivo Black', sans-serif;
            font-size: 2em;
            color: #1a1a1a;
            background: white;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.2);
        }

        h1 {
            font-family: 'Archivo Black', sans-serif;
            font-size: 3.5em;
            color: #f5e6c8;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            line-height: 1.1;
            margin-bottom: 15px;
            text-shadow: 0 3px 6px rgba(0,0,0,0.4);
        }

        .tagline {
            font-size: 1.15em;
            color: #8fbc8f;
            font-weight: 600;
            max-width: 600px;
            margin: 0 auto;
            line-height: 1.6;
        }

        /* === SECTION HEADINGS === */
        h2 {
            font-family: 'Archivo Black', sans-serif;
            font-size: 1.8em;
            color: #f5e6c8;
            text-transform: uppercase;
            letter-spacing: 0.04em;
            margin: 60px 0 25px;
            padding-bottom: 12px;
            border-bottom: 3px solid #8b5e3c;
            position: relative;
        }

        h2::before {
            content: '';
            position: absolute;
            bottom: -3px;
            left: 0;
            width: 60px;
            height: 3px;
            background: #cc2936;
        }

        h3 {
            font-family: 'Inter', sans-serif;
            font-size: 1.2em;
            font-weight: 900;
            color: #8fbc8f;
            text-transform: uppercase;
            letter-spacing: 0.06em;
            margin: 30px 0 12px;
        }

        p {
            font-size: 1.05em;
            line-height: 1.8;
            margin-bottom: 18px;
            color: #d4ccbc;
        }

        a { color: #8fbc8f; }

        /* === PHOTO GRID === */
        .photo-rack {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }

        .photo-rack.single {
            grid-template-columns: 1fr;
            max-width: 500px;
            margin-left: auto;
            margin-right: auto;
        }

        .photo-card {
            position: relative;
            border-radius: 8px;
            overflow: hidden;
            border: 3px solid #8b5e3c;
            box-shadow: 0 6px 20px rgba(0,0,0,0.4);
            background: #2a1a08;
        }

        .photo-card img {
            width: 100%;
            height: auto;
            display: block;
        }

        .photo-card .caption {
            padding: 10px 14px;
            font-size: 0.85em;
            font-weight: 600;
            color: #8fbc8f;
            background: #0d2618;
            border-top: 2px solid #8b5e3c;
        }

        /* === FELT CALLOUT BOX === */
        .callout {
            background: #0d2618;
            border: 2px solid #8b5e3c;
            border-radius: 8px;
            padding: 28px 30px;
            margin: 30px 0;
            position: relative;
            box-shadow: inset 0 2px 8px rgba(0,0,0,0.3);
        }

        .callout::before {
            content: '';
            position: absolute;
            top: 14px;
            right: 16px;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: radial-gradient(circle at 35% 35%, #ff6b6b, #cc2936 50%, #6b0000);
            box-shadow: inset -2px -2px 4px rgba(0,0,0,0.3), 0 2px 6px rgba(0,0,0,0.3);
        }

        .callout h3 { margin-top: 0; }
        .callout p:last-child { margin-bottom: 0; }

        /* === CODE BLOCKS === */
        code {
            font-family: 'IBM Plex Mono', monospace;
            background: rgba(0,0,0,0.3);
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 0.9em;
            color: #8fbc8f;
        }

        pre {
            background: #0a0a0a;
            border: 2px solid #333;
            border-radius: 6px;
            padding: 20px;
            overflow-x: auto;
            margin: 20px 0;
            font-family: 'IBM Plex Mono', monospace;
            font-size: 0.85em;
            line-height: 1.6;
            color: #8fbc8f;
        }

        /* === WIRING TABLE === */
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            font-size: 0.95em;
        }

        th {
            background: #0d2618;
            color: #f5e6c8;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            font-size: 0.85em;
            padding: 12px 16px;
            text-align: left;
            border-bottom: 2px solid #8b5e3c;
        }

        td {
            padding: 10px 16px;
            border-bottom: 1px solid rgba(139,94,60,0.3);
            color: #d4ccbc;
        }

        tr:hover td { background: rgba(0,0,0,0.15); }

        /* === BYTE MAP === */
        .byte-map {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 4px;
            margin: 20px 0;
            max-width: 500px;
        }

        .bit {
            text-align: center;
            padding: 8px 4px;
            border-radius: 4px;
            font-family: 'IBM Plex Mono', monospace;
            font-size: 0.75em;
            font-weight: 700;
            line-height: 1.3;
        }

        .bit-header {
            background: #0d2618;
            color: #8b5e3c;
            border: 1px solid #8b5e3c;
        }

        .bit-std {
            background: rgba(139,94,60,0.15);
            color: #d4ccbc;
            border: 1px solid rgba(139,94,60,0.3);
        }

        .bit-changed {
            background: rgba(204,41,54,0.2);
            color: #ff6b6b;
            border: 1px solid rgba(204,41,54,0.5);
        }

        /* === BUTTON MAP BALLS === */
        .button-map {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            max-width: 420px;
            margin: 25px auto;
        }

        .btn-ball {
            display: flex;
            align-items: center;
            gap: 14px;
            padding: 14px 18px;
            border-radius: 8px;
            background: #0d2618;
            border: 2px solid rgba(139,94,60,0.4);
        }

        .btn-ball .ball {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Archivo Black', sans-serif;
            font-size: 0.8em;
            flex-shrink: 0;
            box-shadow: inset -3px -3px 6px rgba(0,0,0,0.3), 0 2px 8px rgba(0,0,0,0.3);
        }

        .ball-1 { background: radial-gradient(circle at 35% 35%, #ffeb3b, #f9a825 60%, #c67600); color: #1a1a1a; }
        .ball-2 { background: radial-gradient(circle at 35% 35%, #64b5f6, #1565c0 60%, #0a3d7a); color: white; }
        .ball-3 { background: radial-gradient(circle at 35% 35%, #ff6b6b, #cc2936 60%, #6b0000); color: white; }
        .ball-4 { background: radial-gradient(circle at 35% 35%, #ce93d8, #7b1fa2 60%, #4a0072); color: white; }

        .btn-ball .label {
            font-size: 0.9em;
            font-weight: 700;
            color: #d4ccbc;
        }

        .btn-ball .sublabel {
            font-size: 0.75em;
            color: #8fbc8f;
            margin-top: 2px;
        }

        /* === POCKET DIVIDER === */
        .pocket-divider {
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 50px 0;
            gap: 20px;
        }

        .pocket-divider .line {
            flex: 1;
            height: 2px;
            background: linear-gradient(90deg, transparent, #8b5e3c, transparent);
        }

        .pocket-divider .pocket {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: radial-gradient(circle at center, #0a0a0a, #1a1a1a);
            border: 3px solid #5c3a1e;
            box-shadow: inset 0 3px 8px rgba(0,0,0,0.8);
        }

        /* === FOOTER === */
        .footer {
            text-align: center;
            padding: 40px 20px;
            color: #5c7a5c;
            font-size: 0.85em;
        }

        .footer a { color: #8fbc8f; }

        /* === RESPONSIVE === */
        @media (max-width: 600px) {
            h1 { font-size: 2.2em; }
            h2 { font-size: 1.4em; }
            .container { padding: 20px 16px 60px; }
            .byte-map { grid-template-columns: repeat(4, 1fr); }
            .button-map { grid-template-columns: 1fr; }
            .rail-diamonds { gap: 30px; }
        }
    </style>
</head>
<body>
    <div class="rail">
        <div class="rail-diamonds">
            <div class="diamond"></div>
            <div class="diamond"></div>
            <div class="diamond"></div>
            <div class="diamond"></div>
            <div class="diamond"></div>
            <div class="diamond"></div>
            <div class="diamond"></div>
        </div>
    </div>

    <div class="container">
        <!-- HERO -->
        <div class="hero">
            <div class="ball-number"><span>4</span></div>
            <h1>ThinkHarder-USB</h1>
            <p class="tagline">Reverse-engineering Kensington's secret PS/2 protocol to give a billiard ball trackball new life over USB</p>
        </div>

        <!-- THE TRACKBALL -->
        <div class="photo-rack single">
            <div class="photo-card">
                <img src="images/trackball.jpg" alt="Kensington Expert Mouse trackball with red billiard ball">
                <div class="caption">The Kensington Expert Mouse &mdash; not actually a billiard ball, but close enough that people steal cue balls for them</div>
            </div>
        </div>

        <p>The <strong>Kensington Expert Mouse</strong> is a PS/2 trackball with a 55mm phenolic resin ball that looks and feels like something you'd find on a pool table. Four symmetrical buttons surround the ball. It's heavy, precise, and built like it predates the concept of planned obsolescence.</p>

        <p>It also has a secret: Kensington implemented a proprietary PS/2 protocol extension called <strong>ThinkingMouse</strong> to support buttons 3 and 4. Without the correct initialization sequence, those buttons silently mirror buttons 1 and 2. The protocol was never publicly documented. Kensington took it to the grave.</p>

        <div class="callout">
            <h3>The Problem</h3>
            <p>Modern computers don't have PS/2 ports. Active USB-to-PS/2 adapters don't speak the ThinkingMouse protocol&mdash;they only handle standard 3-button PS/2 mice. There is no off-the-shelf solution to use this trackball with all 4 buttons on a modern machine.</p>
        </div>

        <div class="pocket-divider"><div class="line"></div><div class="pocket"></div><div class="line"></div></div>

        <!-- THE BUILD -->
        <h2>The Build</h2>

        <p>A <strong>Pro Micro</strong> (ATmega32U4) running <strong>QMK Firmware</strong> acts as a PS/2-to-USB bridge. The Pro Micro speaks PS/2 on one side (interrupt-driven, hardware-timed) and USB HID on the other. QMK handles the USB mouse report generation.</p>

        <div class="photo-rack">
            <div class="photo-card">
                <img src="images/what-worked.jpg" alt="Full setup showing trackball, Pro Micro, and crossed-out USB-PS/2 adapter">
                <div class="caption">The active USB-PS/2 adapter (crossed out) doesn't speak ThinkingMouse</div>
            </div>
            <div class="photo-card">
                <img src="images/board-front.jpg" alt="Pro Micro on perfboard, front side with screw terminal and reset button">
                <div class="caption">Pro Micro on perfboard with screw terminal and reset button</div>
            </div>
        </div>

        <div class="photo-rack">
            <div class="photo-card">
                <img src="images/board-angle.jpg" alt="Angled view of the converter board showing wiring">
                <div class="caption">4.7k pull-ups, screw terminal for the PS/2 cable, and a little red jellybean reset button</div>
            </div>
            <div class="photo-card">
                <img src="images/board-back.jpg" alt="Back side of the perfboard showing solder traces">
                <div class="caption">The back side &mdash; hand-routed solder traces</div>
            </div>
        </div>

        <h3>Wiring</h3>

        <table>
            <tr><th>PS/2 Pin</th><th>Signal</th><th>Pro Micro Pin</th></tr>
            <tr><td>1</td><td>Data</td><td>Pin 9 (PB5)</td></tr>
            <tr><td>5</td><td>Clock</td><td>Pin 7 (PE6)</td></tr>
            <tr><td>4</td><td>VCC</td><td>VCC (5V)</td></tr>
            <tr><td>3</td><td>GND</td><td>GND</td></tr>
        </table>

        <p><strong>4.7k pull-up resistors</strong> from Clock to VCC and Data to VCC. PS/2 is an open-collector bus&mdash;the host must provide pull-ups. The ATmega32U4's internal pull-ups (~20-50k) are too weak and cause framing errors.</p>

        <div class="pocket-divider"><div class="line"></div><div class="pocket"></div><div class="line"></div></div>

        <!-- THE PROTOCOL -->
        <h2>The ThinkingMouse Protocol</h2>

        <p>The ThinkingMouse protocol was reverse-engineered from the <strong>FreeBSD <code>psm.c</code></strong> kernel driver and the <strong>X.org <code>xf86-input-mouse</code></strong> driver source&mdash;the only two places on earth this protocol is documented in code.</p>

        <h3>Detection &amp; Init</h3>

        <p>The magic sequence that wakes up the 4th button:</p>

        <pre>1. Set sample rate to 10      &rarr; triggers native mode
2. Get device ID               &rarr; returns 0x02 (normally 0x00)
3. Set resolution LOW
4. Send magic rate sequence:    {20, 60, 40, 20, 20, 60, 40, 20, 20}
5. Re-enable data reporting</pre>

        <p>Without step 4, buttons 3 and 4 silently mirror buttons 1 and 2. The mouse lies to you and you'd never know.</p>

        <h3>Byte 0 Reinterpretation</h3>

        <p>In native mode, the ThinkingMouse repurposes three bits of the standard PS/2 byte 0:</p>

        <div class="byte-map">
            <div class="bit bit-header">bit 7</div>
            <div class="bit bit-header">bit 6</div>
            <div class="bit bit-header">bit 5</div>
            <div class="bit bit-header">bit 4</div>
            <div class="bit bit-header">bit 3</div>
            <div class="bit bit-header">bit 2</div>
            <div class="bit bit-header">bit 1</div>
            <div class="bit bit-header">bit 0</div>

            <div class="bit bit-changed">sync<br><small>was Y&nbsp;ovf</small></div>
            <div class="bit bit-changed">X MSB<br><small>was X&nbsp;ovf</small></div>
            <div class="bit bit-std">Y sign</div>
            <div class="bit bit-std">X sign</div>
            <div class="bit bit-changed">btn 4<br><small>was sync</small></div>
            <div class="bit bit-std">btn 3</div>
            <div class="bit bit-std">btn 2</div>
            <div class="bit bit-std">btn 1</div>
        </div>

        <p><strong>Bit 7</strong> becomes a sync marker (always 1), used to detect dropped bytes. <strong>Bit 6</strong> carries the MSB of X movement data&mdash;the mouse only sends 7 bits of X in byte 1, hiding the 8th bit here. <strong>Bit 3</strong> gains button 4 where the standard PS/2 sync bit used to live.</p>

        <div class="callout">
            <h3>The X MSB Kludge</h3>
            <p>This is the weirdest part of the protocol. The mouse splits X movement across two locations: 7 bits in byte 1 and 1 bit in byte 0. Without reconstructing the MSB, moving left produces garbage values. FreeBSD calls this the "Kensington kludge" in the source comments.</p>
        </div>

        <div class="pocket-divider"><div class="line"></div><div class="pocket"></div><div class="line"></div></div>

        <!-- THE BUTTON MAP -->
        <h2>Button Map</h2>

        <div class="button-map">
            <div class="btn-ball">
                <div class="ball ball-4">4</div>
                <div>
                    <div class="label">Top-Left</div>
                    <div class="sublabel">Button 4</div>
                </div>
            </div>
            <div class="btn-ball">
                <div class="ball ball-3">3</div>
                <div>
                    <div class="label">Top-Right</div>
                    <div class="sublabel">Middle / Scroll</div>
                </div>
            </div>
            <div class="btn-ball">
                <div class="ball ball-1">1</div>
                <div>
                    <div class="label">Bottom-Left</div>
                    <div class="sublabel">Left Click</div>
                </div>
            </div>
            <div class="btn-ball">
                <div class="ball ball-2">2</div>
                <div>
                    <div class="label">Bottom-Right</div>
                    <div class="sublabel">Right Click</div>
                </div>
            </div>
        </div>

        <p>Top-left and top-right are swapped in firmware so the top-right button (more natural reach) acts as middle-click and scroll. Hold it and roll the ball to scroll.</p>

        <div class="pocket-divider"><div class="line"></div><div class="pocket"></div><div class="line"></div></div>

        <!-- THE QMK PATCHES -->
        <h2>QMK Driver Patches</h2>

        <p>The stock QMK PS/2 mouse driver only supports 3-button standard PS/2 mice. ThinkHarder-USB patches the driver with:</p>

        <p><code>PS2_MOUSE_THINKING</code> &mdash; Full ThinkingMouse protocol handling: sync checking against bit 7, X MSB reconstruction from bit 6, overflow bit reinterpretation so QMK doesn't clip all Y movement to &plusmn;127.</p>

        <p><code>PS2_MOUSE_SKIP_RESET</code> &mdash; Skips the PS/2 reset command on init. The mouse already did BAT on power-up, and stale BAT bytes in the ring buffer cause protocol desync and phantom right-clicks.</p>

        <p><code>PS2_MOUSE_THINKING_BTN_SWAP</code> &mdash; Swaps two button bits for physical remapping without touching the keymap.</p>

        <p><strong>Sync recovery flush</strong> &mdash; When a desync is detected (byte 0 missing bit 7), the driver now flushes remaining bytes from the broken packet instead of discarding one byte at a time. This was the fix for phantom button releases during click-and-drag: a parity error dropping byte 0 would let byte 2 (Y movement with bit 7 set for negative values) pass the sync check as a fake byte 0, producing a phantom button release.</p>

        <div class="pocket-divider"><div class="line"></div><div class="pocket"></div><div class="line"></div></div>

        <!-- THE DEBUGGING JOURNEY -->
        <h2>The Debugging Journey</h2>

        <p>Nothing about this project worked on the first try.</p>

        <h3>Device resets on connect</h3>
        <p>The Pro Micro would reset every time the PS/2 cable was plugged in. Suspected power draw, interrupt storms, missing pull-ups. Turned out to be bad wiring. Rewired with proper headers and it stopped.</p>

        <h3>Phantom right-click on startup</h3>
        <p>The mouse's power-on self-test (BAT) sends <code>0xAA</code>. This byte sat in the ring buffer and got interpreted as a mouse packet: <code>0xAA & 0x07 = 0x02</code> = right button. Fixed by flushing stale bytes before enabling reporting.</p>

        <h3>Buttons 3+4 mirror buttons 1+2</h3>
        <p>Without the ThinkingMouse init sequence, the mouse only reports 2-bit button state. Implemented the magic sample rate sequence from FreeBSD's <code>enable_kmouse()</code>. All four buttons now report distinct values.</p>

        <h3>All Y movement clips to max speed</h3>
        <p>ThinkingMouse bit 7 is always 1 (sync), but QMK interprets it as "Y overflow" and clips Y to &plusmn;127. Fixed by stripping bits 6 and 7 before QMK processes them.</p>

        <h3>Moving left jerks to the edge of the screen</h3>
        <p>The mouse only sends 7 bits of X in byte 1. Negative X values lose their MSB, turning -5 into +123, which QMK then clips to -127. The "Kensington kludge": reconstruct the MSB from byte 0 bit 6.</p>

        <h3>Double-click during click-and-drag</h3>
        <p>The real beast. A parity error on the PS/2 bus would silently drop byte 0. The old sync check discarded one byte at a time, but bytes 1 and 2 from the broken packet stayed in the buffer. Byte 2 (Y data) with a negative value has bit 7 set&mdash;passing the sync check as a fake byte 0 with garbage button state. One frame of "buttons = 0" mid-drag = the OS sees a double-click. Fixed by flushing the entire broken packet on sync failure instead of discarding one byte.</p>

        <div class="pocket-divider"><div class="line"></div><div class="pocket"></div><div class="line"></div></div>

        <!-- SOURCE -->
        <h2>Source</h2>

        <p><a href="https://github.com/LXXero/ThinkHarder-USB">github.com/LXXero/ThinkHarder-USB</a></p>

        <p>Includes the QMK keyboard definition, ThinkingMouse init sequence, driver patch, and build instructions.</p>

        <h3>Protocol Sources</h3>
        <p>FreeBSD <code>sys/dev/atkbdc/psm.c</code> &mdash; <code>enable_kmouse()</code> function<br>
        X.org <code>xf86-input-mouse</code> <code>src/mouse.c</code> &mdash; <code>PROT_THINKPS2</code> parser<br>
        Linux <code>drivers/input/mouse/psmouse-base.c</code> &mdash; <code>thinking_detect()</code></p>
    </div>

    <div class="footer">
        <p>ThinkHarder-USB &mdash; QMK firmware for the Kensington Expert Mouse PS/2 trackball</p>
        <p>built by <a href="https://github.com/LXXero">xero</a> + claude</p>
    </div>
</body>
</html>
